<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>회원가입 - 오늘득템</title>
<script type="text/javascript">


</script>
<style>
/* ===== 공통: 메인 톤 ===== */
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}

body {
	font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
		'Helvetica Neue', Arial, sans-serif;
	background: #f8f9fa;
	color: #333;
}

header {
	background: linear-gradient(135deg, #e4f7dd 0%, #2F9D27 100%);
	color: #fff;
	padding: 1rem 0;
	box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
}

.header-container {
	max-width: 1200px;
	margin: 0 auto;
	padding: 0 20px;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.logo {
	font-size: 1.8rem;
	font-weight: 800;
	cursor: pointer;
}

.nav-menu {
	display: flex;
	gap: 2rem;
	list-style: none;
}

.nav-menu a {
	color: #fff;
	text-decoration: none;
	font-weight: 500;
	opacity: .95;
	transition: opacity .2s;
}

.nav-menu a:hover {
	opacity: .8;
}

/* ===== 레이아웃 ===== */
.outer {
	max-width: 1200px;
	margin: 0 auto;
	padding: 40px 20px;
	/* 중앙 정렬 추가 */
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: calc(100vh - 200px); /* 헤더, 푸터 제외한 높이 확보 */
}

/* ===== 가입 폼 카드 ===== */
.card {
	background: #fff;
	border-radius: 14px;
	padding: 26px;
	box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
	border: 1px solid #eee;
	/* 폼을 화면 중앙에 고정 배치 */
	width: 100%;
	max-width: 700px; /* 중앙에 보기 좋은 폼 폭 */
	margin: 0 auto;
}

.card h2 {
	font-size: 1.6rem;
	font-weight: 800;
	color: #3a5a40;
	margin-bottom: 8px;
	text-align: center;
}

.card .sub {
	text-align: center;
	color: #666;
	margin-bottom: 20px;
}

.form-row {
	display: flex;
	flex-direction: column;
	gap: 8px;
	margin-bottom: 14px;
}

label {
	font-weight: 700;
	color: #333;
}

input[type="text"], input[type="password"], input[type="email"], input[type="tel"], textarea
	{
	padding: 14px 16px;
	border: 2px solid #e6e6f4;
	border-radius: 10px;
	font-size: 1rem;
	background: #fff;
	transition: border-color .15s, box-shadow .15s;
}

textarea {
	resize: vertical;
	min-height: 100px;
	font-family: inherit;
}

input:focus, textarea:focus {
	outline: none;
	border-color: #3a5a40;
	box-shadow: 0 0 0 3px rgba(58, 90, 64, .15);
}

.row-inline {
	display: flex;
	gap: 8px;
}

.grid-2 {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 12px;
}

@media ( max-width : 560px) {
	.grid-2 {
		grid-template-columns: 1fr;
	}
}

.helper {
	font-size: .9rem;
	color: #777;
}

.error {
	display: none;
	color: #c0392b;
	font-size: .88rem;
	margin-top: -4px;
}

.pw-wrap {
	margin-top: 4px;
}

.pw-meter {
	width: 100%;
	height: 8px;
	background: #e4f7dd;
	border-radius: 6px;
	overflow: hidden;
	border: 1px solid #e4e6ff;
}

.pw-bar {
	height: 100%;
	width: 0%;
	background: linear-gradient(135deg, #ff9a9e, #fad0c4);
	transition: width .2s;
}

.btn-primary {
	width: 100%;
	padding: 14px 16px;
	border: none;
	border-radius: 10px;
	cursor: pointer;
	background: linear-gradient(135deg,#3a5a40 100%);
	color: #fff;
	font-weight: 800;
	font-size: 1rem;
	box-shadow: 0 8px 16px rgba(102, 126, 234, .25);
	transition: transform .12s;
}

.btn-primary:hover {
	transform: translateY(-2px);
}

.btn-ghost {
	width: 100%;
	padding: 12px 16px;
	border-radius: 10px;
	border: 2px solid #e6e6f4;
	background: #fff;
	color: #333;
	font-weight: 800;
}

.mini {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-top: 10px;
	font-size: .92rem;
}

.mini a {
	color: #3a5a40;
	text-decoration: none;
}

.mini a:hover {
	text-decoration: underline;
}

footer {
	background: #2c3e50;
	color: #fff;
	padding: 28px 0;
	text-align: center;
	margin-top: 34px;
}
</style>
</head>
<body>
	<!-- 헤더 -->
	<div th:replace="~{layouts/header.html}"></div>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>

	<!-- 본문 -->

	<!-- 우측: 가입 폼 -->
	<section class="card">
		<h2>회원가입</h2>
		<p class="sub">정보를 입력하면 바로 오늘득템을 이용할 수 있어요.</p>

		<!-- 경로는 /user 로 통일 -->
		<form action="/user/write" name="frm" method="post" enctype="multipart/form-data"
			onsubmit="return submitJoin();">
			
			<!-- 프로필 사진 업로드 -->
			<div class="form-row" style="text-align: center; margin-bottom: 24px;">
				<label style="margin-bottom: 12px;">프로필 사진 (선택)</label>
				<div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
					<div id="profilePreview" style="width: 120px; height: 120px; background: linear-gradient(135deg, #e4f7dd 0%, #e4f9dd 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 3.5rem; overflow: hidden; border: 3px solid #e6e6f4;">
						<span id="profileIcon">👤</span>
						<img id="previewImage" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
					</div>
					<input type="file" id="profileImage" name="profileImage" accept="image/*" style="display: none;" onchange="previewProfileImage(event)">
					<button type="button" class="btn-ghost" style="width: auto; padding: 10px 20px;" onclick="document.getElementById('profileImage').click()">사진 선택</button>
					<small class="helper">jpg, png 파일 (최대 10MB)</small>
				</div>
			</div>
			
			<div class="form-row">
				<label for="email">이메일 (로그인 ID) <span style="color: red;">*</span></label>
				<div class="row-inline">
					<input type="email" id="email" name="email" placeholder="이메일을 입력하세요"
						required>
					<button type="button" class="btn-ghost" id="sendCodeBtn"
						style="width: auto; padding: 12px 14px" onclick="sendVerificationCode()">인증번호 받기</button>
				</div>
				<small class="helper">예: user@example.com</small>
				<div id="emailError" class="error">이메일 형식을 확인하세요.</div>
				<div id="emailSuccess" class="error" style="color: #28a745; display: none;">✓ 인증번호가 발송되었습니다.</div>
			</div>
			
			<div class="form-row" id="verificationRow" style="display: none;">
				<label for="verificationCode">인증번호 입력 <span style="color: red;">*</span></label>
				<div class="row-inline">
					<input type="text" id="verificationCode" placeholder="6자리 인증번호"
						maxlength="6" pattern="[0-9]{6}">
					<button type="button" class="btn-ghost"
						style="width: auto; padding: 12px 14px" onclick="verifyCode()">인증 확인</button>
				</div>
				<small class="helper" id="timerText">유효시간: <span style="color: #e74c3c; font-weight: 600;">5:00</span></small>
				<div id="verifyError" class="error">인증번호가 일치하지 않습니다.</div>
				<div id="verifySuccess" class="error" style="color: #28a745; display: none;">✓ 이메일 인증이 완료되었습니다!</div>
			</div>

			<div class="grid-2">
				<div class="form-row">
					<label for="pwd">비밀번호</label>
					<div class="row-inline">
						<input type="password" id="pwd" name="pwd"
							placeholder="영문/숫자/특수문자 8~20자" minlength="8" maxlength="20"
							required oninput="updatePwMeter()">
						<button type="button" class="btn-ghost" style="width: auto"
							onclick="togglePwd('pwd', this)">보기</button>
					</div>
					<div class="pw-wrap">
						<div class="pw-meter">
							<div id="pwBar" class="pw-bar"></div>
						</div>
						<small id="pwTip" class="helper">안전한 비밀번호를 입력하세요.</small>
					</div>
					<div id="pwdError" class="error">비밀번호 형식을 확인하세요.</div>
				</div>
				<div class="form-row">
					<label for="pwd2">비밀번호 확인</label>
					<div class="row-inline">
						<input type="password" id="pwd2" name="pwd2" placeholder="한번 더 입력"
							minlength="8" maxlength="20" required>
						<button type="button" class="btn-ghost" style="width: auto"
							onclick="togglePwd('pwd2', this)">보기</button>
					</div>
					<div id="pwd2Error" class="error">비밀번호가 일치하지 않습니다.</div>
				</div>
			</div>

			<div class="grid-2">
				<div class="form-row">
					<label for="name">이름</label> <input type="text" id="name"
						name="name" placeholder="이름" required>
				</div>
				<div class="form-row">
					<label for="tel">휴대폰</label> 
					<input type="tel" id="tel" name="tel"
						placeholder="01012345678 (숫자만 입력)"
						pattern="^01[0-9]{8,9}$" maxlength="11" onblur="checkPhoneDuplicate()">
					<div id="phoneError" class="error">이미 사용 중인 전화번호입니다.</div>
					<div id="phoneSuccess" class="error" style="color: #28a745; display: none;">✓ 사용 가능한 전화번호입니다.</div>
				</div>
			</div>

			<div class="form-row">
				<label for="postcode">주소</label>
				<div>
					<input type="text" id="postcode" name="zipcode" placeholder="우편번호"
						readonly style="max-width: 160px">
					<button type="button" class="btn-ghost" style="width: auto;"
						onclick="execPostcode()">우편번호 찾기</button>
				</div>
				<small class="helper">'우편번호 찾기' 버튼을 눌러 주소를 검색해 주세요.</small>
			</div>

			<div class="form-row">
				<input type="text" id="roadAddress" name="addrRoad"
					placeholder="도로명 주소" readonly>
			</div>
			<div class="form-row">
				<input type="text" id="jibunAddress" name="addrJibun"
					placeholder="지번 주소" readonly>
			</div>
			<div class="form-row">
				<input type="text" id="extraAddress" name="addrExtra"
					placeholder="참고 항목(동/건물명 등)" readonly>
			</div>
			<div class="form-row">
				<input type="text" id="detailAddress" name="addrDetail"
					placeholder="상세 주소(동/호수 등)" required>
			</div>

			<div class="form-row">
				<label for="introduce">자기소개 (선택)</label>
				<textarea id="introduce" name="introduce" placeholder="간단한 자기소개를 입력해주세요 (선택사항)"></textarea>
			</div>

			<div style="margin-top: 12px"></div>
			<button type="submit" class="btn-primary">회원가입</button>
			<div class="mini">
				<a href="/user/loginForm">이미 계정이 있으신가요? 로그인</a> <a href="/index">메인으로</a>
			</div>
		</form>
	</section>
	</div>
	</div>

	<div th:replace="~{layouts/footer.html}"></div>


	<script
		src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
		// 전역 변수
		let timerInterval = null;
		let isEmailVerified = false;
		let isPhoneAvailable = true;  // 전화번호 사용 가능 여부
		
		// 이메일 인증번호 발송
		function sendVerificationCode() {
			const email = document.getElementById('email').value.trim();
			
			if(!email) {
				alert('이메일을 입력해주세요.');
				return;
			}
			
			// 이메일 형식 검증
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			if(!emailRegex.test(email)) {
				alert('올바른 이메일 형식을 입력해주세요.');
				return;
			}
			
			// 버튼 비활성화
			const sendBtn = document.getElementById('sendCodeBtn');
			sendBtn.disabled = true;
			sendBtn.textContent = '발송 중...';
			
			// 서버에 인증번호 요청
			fetch('/user/sendVerificationCode', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: 'email=' + encodeURIComponent(email)
			})
			.then(response => response.json())
			.then(data => {
				if(data.result === 1) {
					// 성공
					document.getElementById('emailSuccess').style.display = 'block';
					document.getElementById('emailError').style.display = 'none';
					document.getElementById('verificationRow').style.display = 'flex';
					document.getElementById('email').readOnly = true;
					
					sendBtn.textContent = '재발송';
					sendBtn.disabled = false;
					
					// 타이머 시작 (5분)
					startTimer(300);
					
					alert(data.message);
				} else if(data.result === -1) {
					// 이메일 중복
					alert(data.message);
					sendBtn.disabled = false;
					sendBtn.textContent = '인증번호 받기';
				} else {
					// 실패
					alert(data.message);
					sendBtn.disabled = false;
					sendBtn.textContent = '인증번호 받기';
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('인증번호 발송에 실패했습니다.');
				sendBtn.disabled = false;
				sendBtn.textContent = '인증번호 받기';
			});
		}
		
		// 인증번호 확인
		function verifyCode() {
			const email = document.getElementById('email').value.trim();
			const code = document.getElementById('verificationCode').value.trim();
			
			if(!code || code.length !== 6) {
				alert('6자리 인증번호를 입력해주세요.');
				return;
			}
			
			fetch('/user/verifySignupCode', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: 'email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code)
			})
			.then(response => response.json())
			.then(data => {
				if(data.result === 1) {
					// 인증 성공
					document.getElementById('verifySuccess').style.display = 'block';
					document.getElementById('verifyError').style.display = 'none';
					document.getElementById('verificationCode').readOnly = true;
					isEmailVerified = true;
					
					// 타이머 중지 및 숨김
					if(timerInterval) {
						clearInterval(timerInterval);
					}
					document.getElementById('timerText').style.display = 'none';
					
					alert(data.message);
				} else {
					// 인증 실패
					document.getElementById('verifyError').style.display = 'block';
					document.getElementById('verifyError').textContent = data.message;
					alert(data.message);
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('인증 확인에 실패했습니다.');
			});
		}
		
		// 전화번호 중복 체크
		function checkPhoneDuplicate() {
			const phoneInput = document.getElementById('tel');
			const phone = phoneInput.value.trim();
			const phoneError = document.getElementById('phoneError');
			const phoneSuccess = document.getElementById('phoneSuccess');
			
			// 전화번호가 비어있으면 체크 안함 (선택 항목이므로)
			if(!phone) {
				phoneError.style.display = 'none';
				phoneSuccess.style.display = 'none';
				isPhoneAvailable = true;
				return;
			}
			
			// 전화번호 형식 체크 (01로 시작하는 9~11자리 숫자)
			const phonePattern = /^01[0-9]{8,9}$/;
			if(!phonePattern.test(phone)) {
				phoneError.textContent = '올바른 휴대폰 번호 형식이 아닙니다. (예: 01012345678)';
				phoneError.style.display = 'block';
				phoneSuccess.style.display = 'none';
				isPhoneAvailable = false;
				return;
			}
			
			// 서버에 중복 체크 요청
			fetch('/user/checkPhone?phone=' + encodeURIComponent(phone))
				.then(response => response.json())
				.then(data => {
					if(data.isExist) {
						// 전화번호 중복
						phoneError.textContent = '이미 사용 중인 전화번호입니다.';
						phoneError.style.display = 'block';
						phoneSuccess.style.display = 'none';
						isPhoneAvailable = false;
						phoneInput.style.borderColor = '#e74c3c';
					} else {
						// 사용 가능
						phoneError.style.display = 'none';
						phoneSuccess.style.display = 'block';
						isPhoneAvailable = true;
						phoneInput.style.borderColor = '#28a745';
					}
				})
				.catch(error => {
					console.error('Error:', error);
					phoneError.textContent = '전화번호 확인 중 오류가 발생했습니다.';
					phoneError.style.display = 'block';
					phoneSuccess.style.display = 'none';
					isPhoneAvailable = false;
				});
		}
		
		
		// 타이머 시작
		function startTimer(seconds) {
			let timeLeft = seconds;
			const timerSpan = document.querySelector('#timerText span');
			
			// 기존 타이머 정지
			if(timerInterval) {
				clearInterval(timerInterval);
			}
			
			timerInterval = setInterval(function() {
				const minutes = Math.floor(timeLeft / 60);
				const secs = timeLeft % 60;
				
				timerSpan.textContent = minutes + ':' + (secs < 10 ? '0' : '') + secs;
				
				timeLeft--;
				
				if(timeLeft < 0) {
					clearInterval(timerInterval);
					timerSpan.textContent = '만료됨';
					alert('인증 시간이 만료되었습니다. 인증번호를 다시 받아주세요.');
				}
			}, 1000);
		}
		
		// 프로필 이미지 미리보기
		function previewProfileImage(event) {
			const file = event.target.files[0];
			if (file) {
				// 파일 크기 체크 (10MB)
				if (file.size > 10 * 1024 * 1024) {
					alert('파일 크기는 10MB 이하만 가능합니다.');
					event.target.value = '';
					return;
				}
				
				// 이미지 파일인지 체크
				if (!file.type.startsWith('image/')) {
					alert('이미지 파일만 업로드 가능합니다.');
					event.target.value = '';
					return;
				}
				
				// 미리보기 표시
				const reader = new FileReader();
				reader.onload = function(e) {
					document.getElementById('profileIcon').style.display = 'none';
					const previewImage = document.getElementById('previewImage');
					previewImage.src = e.target.result;
					previewImage.style.display = 'block';
				}
				reader.readAsDataURL(file);
			}
		}
		
		function execPostcode() {
			new daum.Postcode({
				oncomplete : function(data) {
					var roadAddr = data.roadAddress || '';
					var jibunAddr = data.jibunAddress || '';
					var extraRoad = '';

					if (data.bname && /[동|로|가]$/g.test(data.bname)) {
						extraRoad += data.bname;
					}
					if (data.buildingName && data.apartment == 'Y') {
						extraRoad += (extraRoad !== '' ? ', '
								+ data.buildingName : data.buildingName);
					}
					if (extraRoad !== '') {
						extraRoad = '(' + extraRoad + ')';
					}

					document.getElementById('postcode').value = data.zonecode;
					document.getElementById('roadAddress').value = roadAddr;
					document.getElementById('jibunAddress').value = jibunAddr;
					document.getElementById('extraAddress').value = extraRoad;

					document.getElementById('detailAddress').focus();

				}
			}).open();
		}

		function openIdCheck() {
			const email = document.getElementById('email').value.trim();
			if (!email) {
				alert('이메일을 입력하세요.');
				return;
			}
			// 이메일 형식 체크
			const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			if (!emailPattern.test(email)) {
				alert('올바른 이메일 형식을 입력하세요.');
				return;
			}
			window.open('/user/checkEmail?email=' + encodeURIComponent(email),
					'emailCheck', 'width=450,height=350');
		}

		function togglePwd(id, btn) {
			const el = document.getElementById(id);
			if (el.type === 'password') {
				el.type = 'text';
				btn.textContent = '숨기기';
			} else {
				el.type = 'password';
				btn.textContent = '보기';
			}
		}

		function updatePwMeter() {
			const v = document.getElementById('pwd').value;
			const bar = document.getElementById('pwBar');
			const tip = document.getElementById('pwTip');
			let score = 0;
			if (v.length >= 8)
				score++;
			if (/[A-Z]/.test(v))
				score++;
			if (/[a-z]/.test(v))
				score++;
			if (/[0-9]/.test(v))
				score++;
			if (/[^A-Za-z0-9]/.test(v))
				score++;

			const pct = Math.min(100, score * 20);
			bar.style.width = pct + '%';
			if (score <= 2) {
				bar.style.background = 'linear-gradient(135deg, #ff9a9e, #fecfef)';
				tip.textContent = '약함: 대/소문자, 숫자, 특수문자를 조합해 보세요.';
			} else if (score === 3) {
				bar.style.background = 'linear-gradient(135deg, #f6d365, #fda085)';
				tip.textContent = '보통: 조금만 더 강하게!';
			} else {
				bar.style.background = 'linear-gradient(135deg, #a1ffce, #faffd1)';
				tip.textContent = '강함: 안전한 비밀번호입니다.';
			}
		}

	// 회원가입 버튼 클릭 시 실행
	async function submitJoin() {
		const email = document.getElementById('email');
		const pwd = document.getElementById('pwd');
		const pwd2 = document.getElementById('pwd2');
		const tel = document.getElementById('tel');

		// 이메일 인증 확인
		if(!isEmailVerified) {
			alert('이메일 인증을 완료해주세요.');
			email.focus();
			return false;
		}

		// 이메일 형식 체크
		const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		const emailOk = emailPattern.test(email.value);
		document.getElementById('emailError').style.display = emailOk ? 'none' : 'block';

		if (!emailOk) {
			alert('이메일 형식을 확인하세요.');
			email.focus();
			return false;
		}

		// 비밀번호 길이 체크
		const pwdOk = (pwd.value.length >= 8);
		document.getElementById('pwdError').style.display = pwdOk ? 'none' : 'block';

		if (!pwdOk) {
			alert('비밀번호는 8자 이상이어야 합니다.');
			pwd.focus();
			return false;
		}

		// 비밀번호 일치 체크
		const match = (pwd.value === pwd2.value);
		document.getElementById('pwd2Error').style.display = match ? 'none' : 'block';

		if (!match) {
			alert('비밀번호가 일치하지 않습니다.');
			pwd2.focus();
			return false;
		}

		// 전화번호 중복 체크 (전화번호가 입력된 경우만)
		if(tel.value.trim()) {
			const phone = tel.value.trim();
			const phonePattern = /^01[0-9]{8,9}$/;
			
			// 전화번호 형식 체크
			if(!phonePattern.test(phone)) {
				alert('올바른 휴대폰 번호 형식이 아닙니다.\n(예: 01012345678)');
				tel.value = '';  // 입력값 지우기
				tel.focus();
				return false;
			}
			
			// 서버에 중복 체크 요청 (동기식)
			try {
				const response = await fetch('/user/checkPhone?phone=' + encodeURIComponent(phone));
				const data = await response.json();
				
				if(data.isExist) {
					// 전화번호 중복
					alert('⚠️ 이미 사용 중인 전화번호입니다.\n다른 전화번호를 입력해주세요.');
					tel.value = '';  // 입력값 지우기
					tel.style.borderColor = '#e74c3c';
					tel.focus();
					document.getElementById('phoneError').textContent = '이미 사용 중인 전화번호입니다.';
					document.getElementById('phoneError').style.display = 'block';
					document.getElementById('phoneSuccess').style.display = 'none';
					return false;
				}
			} catch(error) {
				console.error('Error:', error);
				alert('전화번호 확인 중 오류가 발생했습니다.');
				return false;
			}
		}

		// 모든 검증 통과
		return true;
	}
	</script>
</body>
</html>
